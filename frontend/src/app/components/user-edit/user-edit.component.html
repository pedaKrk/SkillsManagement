<div class="user-edit-page">
  <!-- loading indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <span>Benutzerdaten werden geladen...</span>
  </div>
  
  <!-- error message -->
  <div *ngIf="error" class="error-container">
    <div class="error-message">{{ error }}</div>
    <div class="error-actions">
      <button class="btn btn-secondary" (click)="cancel()">Zurück zur Benutzerdetailseite</button>
    </div>
  </div>
  
  <!-- edit form -->
  <div *ngIf="user && !isLoading && !error" class="user-edit-container">
    <div class="edit-header">
      <h1>Benutzerprofil bearbeiten</h1>
      <p class="subtitle">Bearbeiten Sie die Informationen für {{ user.firstName }} {{ user.lastName }}</p>
    </div>
    
    <!-- profile image section -->
    <div class="profile-image-section">
      <h2 class="section-title">Profilbild</h2>
      
      <div class="profile-image-container">
        <div class="current-image">
          <div *ngIf="!user.profileImageUrl && !previewImageUrl" class="user-avatar">
            <span class="initials">{{ getUserInitials() }}</span>
          </div>
          <img *ngIf="user.profileImageUrl && !previewImageUrl" [src]="getProfileImageUrl(user.profileImageUrl)" alt="Aktuelles Profilbild" class="profile-image">
          <img *ngIf="previewImageUrl" [src]="previewImageUrl" alt="Neues Profilbild" class="profile-image">
        </div>
        
        <div class="image-actions">
          <label for="profile-image-upload" class="btn btn-primary">
            <i class="fa fa-upload"></i> Bild hochladen
          </label>
          <input type="file" id="profile-image-upload" (change)="onImageSelected($event)" accept="image/*" style="display: none;">
          
          <button *ngIf="user.profileImageUrl || previewImageUrl" type="button" class="btn btn-danger" (click)="markProfileImageForRemoval()">
            <i class="fa fa-trash"></i> Bild entfernen
          </button>
        </div>
        
        <div class="image-info">
          <p class="image-hint">Hinweis: Bilder werden automatisch komprimiert. Maximale Dateigröße vor Komprimierung: 20 MB.</p>
        </div>
        
        <div *ngIf="imageError" class="image-error">
          {{ imageError }}
        </div>
      </div>
    </div>
    
    <form [formGroup]="userForm" (ngSubmit)="saveChanges()" class="edit-form">
      <!-- personal information -->
      <div class="form-section">
        <h2 class="section-title">Persönliche Informationen</h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="title">Titel</label>
            <input type="text" id="title" formControlName="title" class="form-control">
          </div>
          
          <div class="form-group">
            <label for="firstName">Vorname *</label>
            <input type="text" id="firstName" formControlName="firstName" class="form-control" [class.is-invalid]="isFieldInvalid('firstName')">
            <div *ngIf="isFieldInvalid('firstName')" class="invalid-feedback">
              Vorname ist erforderlich
            </div>
          </div>
          
          <div class="form-group">
            <label for="lastName">Nachname *</label>
            <input type="text" id="lastName" formControlName="lastName" class="form-control" [class.is-invalid]="isFieldInvalid('lastName')">
            <div *ngIf="isFieldInvalid('lastName')" class="invalid-feedback">
              Nachname ist erforderlich
            </div>
          </div>
        </div>
      </div>
      
      <!-- contact information -->
      <div class="form-section">
        <h2 class="section-title">Kontaktinformationen</h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="email">E-Mail *</label>
            <input type="email" id="email" formControlName="email" class="form-control" [class.is-invalid]="isFieldInvalid('email')">
            <div *ngIf="isFieldInvalid('email')" class="invalid-feedback">
              Bitte geben Sie eine gültige E-Mail-Adresse ein
            </div>
          </div>
          
          <div class="form-group">
            <label for="phoneNumber">Telefonnummer</label>
            <input type="tel" id="phoneNumber" formControlName="phoneNumber" class="form-control">
          </div>
        </div>
      </div>
      
      <!-- account information -->
      <div class="form-section">
        <h2 class="section-title">Kontoinformationen</h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="username">Benutzername *</label>
            <input type="text" id="username" formControlName="username" class="form-control" [class.is-invalid]="isFieldInvalid('username')">
            <div *ngIf="isFieldInvalid('username')" class="invalid-feedback">
              Benutzername ist erforderlich
            </div>
          </div>
          
          <!-- Role and Employment Type only visible for admins -->
          <ng-container *ngIf="isAdmin">
            <div class="form-group">
              <label for="role">Rolle *</label>
              <select id="role" formControlName="role" class="form-control" [class.is-invalid]="isFieldInvalid('role')">
                <option value="">Rolle auswählen</option>
                <option *ngFor="let role of userRoles" [value]="role">{{ role }}</option>
              </select>
              <div *ngIf="isFieldInvalid('role')" class="invalid-feedback">
                Rolle ist erforderlich
              </div>
            </div>
            
            <div class="form-group">
              <label for="employmentType">Beschäftigungsart *</label>
              <select id="employmentType" formControlName="employmentType" class="form-control" [class.is-invalid]="isFieldInvalid('employmentType')">
                <option value="">Beschäftigungsart auswählen</option>
                <option *ngFor="let type of employmentTypes" [value]="type">{{ type }}</option>
              </select>
              <div *ngIf="isFieldInvalid('employmentType')" class="invalid-feedback">
                Beschäftigungsart ist erforderlich
              </div>
            </div>
          </ng-container>
        </div>
      </div>
      
      <!-- actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()">Abbrechen</button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">Änderungen speichern</button>
      </div>
    </form>
  </div>
</div>
