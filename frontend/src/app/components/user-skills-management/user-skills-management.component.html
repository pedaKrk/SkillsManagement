<div class="skills-management-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <span>{{ 'SKILLS.USER_DATA_LOADING' | translate }}</span>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <div class="error-message">{{ error | translate }}</div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error" class="skills-management-content">
    <div class="content-layout">
      <!-- Skills Management Section -->
      <div class="skills-section">
        <div class="header">
          <h1>{{ 'SKILLS.MANAGE_USER_SKILLS' | translate }}</h1>
          <div class="subtitle" *ngIf="user">{{ 'SKILLS.MANAGE_SKILLS_FOR_USER' | translate }} {{ user.firstName }} {{ user.lastName }}</div>
        </div>

        <!-- Selected Skills Display -->
        <div class="selected-skills">
          <div *ngIf="selectedSkills.length === 0" class="no-skills-selected">
            {{ 'SKILLS.NO_SKILLS_SELECTED' | translate }}
          </div>
          <div class="selected-skills-list">
            <div class="skill-card" *ngFor="let skill of selectedSkills">
              <div class="skill-header">
                <span class="skill-name">{{ skill.skill.name }}</span>
                <button
                  class="btn-remove-skill"
                  (click)="removeSkillWithConfirmation(skill.skill._id)"
                  [title]="'SKILLS.REMOVE_SKILL' | translate"
                >
                  <i class="fa fa-trash"></i>
                </button>
              </div>

              <!-- Level Dropdown -->
              <div class="level-selector-container" *ngIf="skill.levelHistory && skill.levelHistory.length > 0">
                <div class="current-level-display clickable" (click)="skillLevelDropdownState[skill.skill._id] = !skillLevelDropdownState[skill.skill._id]">
                  <span class="level-badge" [ngClass]="skill.levelHistory[skill.levelHistory.length - 1].level.toLowerCase()">
                    {{ 'SKILL_LEVELS.' + skill.levelHistory[skill.levelHistory.length - 1].level | translate }}
                  </span>
                  <i class="fa fa-caret-down level-arrow" [class.rotated]="skillLevelDropdownState[skill.skill._id]"></i>

                  <!-- Tooltip for new skills -->
                  <div class="new-skill-tooltip" *ngIf="newlyAddedSkillId === skill.skill._id">
                    <i class="fa fa-lightbulb"></i>
                    <span>{{ 'SKILLS.SKILL_LEVEL_CHANGE_HINT' | translate }}</span>
                  </div>
                </div>
                
                <div class="level-dropdown" *ngIf="skillLevelDropdownState[skill.skill._id]">
                  <div *ngFor="let level of skillLevels" class="level-option" (click)="setSkillLevel(skill, level); skillLevelDropdownState[skill.skill._id] = false">
                    {{ 'SKILL_LEVELS.' + level | translate }}
                  </div>
                </div>
              </div>

              <div class="skill-history-details">
                <div *ngIf="skill.levelHistory.length > 0" class="skill-meta-modern">
                  {{ 'SKILLS.SKILL_ADDED_BY' | translate }} {{ skill.levelHistory[0].changedBy.firstName }} {{ skill.levelHistory[0].changedBy.lastName }}
                  {{ 'SKILLS.SKILL_ADDED_ON' | translate }} {{ skill.levelHistory[0].changedAt | date:'short' }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Skills Dropdown -->
        <div class="skills-dropdown-container">
          <!-- Loading indicator -->
          <div *ngIf="isLoadingSkills" class="skills-loading">
            <div class="spinner"></div>
            <span>{{ 'SKILLS.SKILLS_LOADING' | translate }}</span>
          </div>

          <!-- Error message -->
          <div *ngIf="skillsError" class="alert alert-danger">
            {{ skillsError | translate }}
            <button type="button" class="btn btn-outline-danger" (click)="retryLoadSkills()">
              {{ 'SKILLS.SKILLS_RETRY' | translate }}
            </button>
          </div>

          <!-- Skills Selection -->
          <div *ngIf="!isLoadingSkills && !skillsError" class="skills-selection">
            <div class="dropdown-wrapper">
              <div class="skills-dropdown-toggle" (click)="toggleSkillDropdown()">
                <span>{{ 'SKILLS.SKILLS_SELECT' | translate }}</span>
                <div class="dropdown-arrow-wrapper">
                  <span class="dropdown-arrow">â–¼</span>
                </div>
              </div>

              <div class="skills-dropdown-menu" *ngIf="isSkillDropdownOpen">
                <div class="skills-search">
                  <input 
                    type="text" 
                    [formControl]="skillSearchControl" 
                    [placeholder]="'SKILLS.SKILLS_SEARCH' | translate"
                    (click)="$event.stopPropagation()"
                  >
                </div>

                <div class="skills-list">
                  <div 
                    *ngFor="let skill of filteredSkills" 
                    class="skill-option"
                    (click)="toggleSkill(skill._id); $event.stopPropagation()"
                  >
                    <input 
                      type="checkbox" 
                      [checked]="isSkillSelected(skill._id)"
                      (click)="$event.stopPropagation()"
                    >
                    <span class="skill-name">{{ skill.name }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="cancel()">
            {{ 'COMMON.CANCEL' | translate }}
          </button>
          <button type="button" class="btn btn-primary" (click)="saveSkills()">
            {{ 'SKILLS.SAVE_CHANGES' | translate }}
          </button>
        </div>
      </div>

      <!-- User Profile Section -->
      <div class="user-profile-section">
        <div class="profile-image-container">
          <!-- Debug Info -->
          <div style="display: none;">
            User Object: {{ user | json }}
            Has Profile Image: {{ user?.profileImageUrl ? 'Yes' : 'No' }}
          </div>
          
          <ng-container *ngIf="user">
            <!-- Initials Avatar -->
            <div *ngIf="!user.profileImageUrl" class="initials-avatar">
              {{ getInitials(user.firstName, user.lastName) }}
            </div>
            
            <!-- Profile Image -->
            <img 
              *ngIf="user.profileImageUrl" 
              [src]="getProfileImageUrl(user.profileImageUrl)" 
              [alt]="user.firstName + ' ' + user.lastName" 
              class="profile-image"
              (error)="user.profileImageUrl = ''"
            >
          </ng-container>
        </div>
        <div class="user-info">
          <h2>{{ user?.firstName }} {{ user?.lastName }}</h2>
          <p class="user-role">{{ formatRole(user?.role) }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
