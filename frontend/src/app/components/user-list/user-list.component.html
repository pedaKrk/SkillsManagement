<div class="user-list-container">
  <!-- action bar -->
  <div class="action-bar">
    <div class="action-buttons-container">
      <div class="action-buttons">
        <!-- PDF and Email Buttons for Admins and Competence Leaders -->
        <button 
          class="btn btn-primary" 
          (click)="generatePDF()" 
          [disabled]="selectedUsers.length === 0"
          *ngIf="isAdmin || isCompetenceLeader"
        >
          {{ 'USER.GENERATE_PDF' | translate }}
        </button>
        <button 
          class="btn btn-primary" 
          (click)="sendEmail()" 
          [disabled]="selectedUsers.length === 0"
          *ngIf="isAdmin || isCompetenceLeader"
        >
          {{ 'USER.SEND_EMAIL' | translate }}
        </button>
        <!-- Sortieren for all available -->
        <button class="btn btn-secondary" (click)="sortUsers('username')">
          {{ 'USER.SORT_ASCENDING' | translate }}
        </button>
      </div>
      
      <div class="filter-controls">
          <!-- Search field -->
        <div class="search-bar">
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            (ngModelChange)="applyFilters()"
            [placeholder]="'USER.SEARCH_BY_NAME' | translate" 
            class="form-control"
          >
        </div>
        
        <div class="filter-row">
          <!-- Skill-Filter Dropdown -->
          <div class="skill-filter">
            <div class="dropdown-wrapper">
              <!-- Dropdown toggle button -->
              <div class="skills-dropdown-toggle" (click)="toggleSkillDropdown()">
                <span>{{ selectedSkills.length > 0 ? ('USER.SKILLS_SELECTED' | translate: {count: selectedSkills.length}) : ('USER.FILTER_BY_SKILLS' | translate) }}</span>
                <span class="dropdown-arrow">{{ isSkillDropdownOpen ? '▲' : '▼' }}</span>
              </div>
              
              <!-- Dropdown menu -->
              <div *ngIf="isSkillDropdownOpen" class="skills-dropdown-menu">
                <!-- Search input -->
                <div class="skills-search">
                  <input 
                    type="text" 
                    [(ngModel)]="skillSearchTerm" 
                    (ngModelChange)="filterSkillsList()"
                    [placeholder]="'USER.SEARCH_SKILLS' | translate" 
                    class="form-control"
                    (click)="$event.stopPropagation()"
                  >
                </div>
                
                <!-- Skills list -->
                <div class="skills-list">
                  <div 
                    class="skill-item" 
                    [class.selected]="selectedSkills.length === 0"
                    (click)="clearAllSkills(); toggleSkillDropdown()"
                  >
                    <div class="skill-checkbox">
                      <span *ngIf="selectedSkills.length === 0" class="check-mark">✓</span>
                    </div>
                    <span class="skill-name">{{ 'USER.SHOW_ALL_SKILLS' | translate }}</span>
                  </div>
                  
                  <div *ngIf="filteredSkillsList.length === 0" class="no-skills">
                    {{ 'USER.NO_SKILLS_FOUND' | translate }}
                  </div>
                  
                  <div 
                    *ngFor="let skill of filteredSkillsList" 
                    class="skill-item" 
                    [class.selected]="isSkillSelected(skill)"
                    (click)="filterBySkill(skill); $event.stopPropagation()"
                  >
                    <div class="skill-checkbox">
                      <span *ngIf="isSkillSelected(skill)" class="check-mark">✓</span>
                    </div>
                    <span class="skill-name">{{ skill }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Selected skills badges (if any) -->
            <div *ngIf="selectedSkills.length > 0" class="selected-skills-container">
              <div *ngFor="let skill of selectedSkills" class="selected-skill-badge">
                <span class="skill-name">{{ skill }}</span>
                <span class="remove-skill" (click)="removeSkill(skill)">×</span>
              </div>
            </div>
          </div>
          
          <!-- Reset Filter Button -->
          <button class="btn reset-filter-btn" 
            [class.btn-secondary]="!hasActiveFilters()" 
            [class.btn-primary]="hasActiveFilters()" 
            (click)="resetFilters()">
            {{ 'USER.CLEAR_ALL_FILTERS' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- loading indicator -->
  <div *ngIf="isLoading" class="loading-indicator">
    <div class="spinner"></div>
    <span>{{ 'USER.USERS_LOADING' | translate }}</span>
  </div>
  
  <!-- error message -->
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
    <button class="btn btn-sm btn-outline-danger ml-2" (click)="loadUsers()">{{ 'USER.RETRY' | translate }}</button>
  </div>
  
  <!-- user table -->
  <div *ngIf="!isLoading && !error" class="user-table-container">
    <table class="user-table">
      <thead>
        <tr>
          <th class="select-column">
            <input 
              type="checkbox" 
              id="select-all-checkbox"
              [checked]="selectedUsers.length === filteredUsers.length && filteredUsers.length > 0"
              (change)="selectAllUsers()"
              [attr.aria-label]="'USER.SELECT_ALL_USERS' | translate"
              class="custom-checkbox"
            >
          </th>
          <th (click)="sortUsers('username')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.USERNAME' | translate }}</span>
              <span *ngIf="sortField === 'username'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('title')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.TITLE' | translate }}</span>
              <span *ngIf="sortField === 'title'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('firstName')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.FIRST_NAME' | translate }}</span>
              <span *ngIf="sortField === 'firstName'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('lastName')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.LAST_NAME' | translate }}</span>
              <span *ngIf="sortField === 'lastName'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('email')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.EMAIL' | translate }}</span>
              <span *ngIf="sortField === 'email'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('phoneNumber')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.PHONE_NUMBER_SHORT' | translate }}</span>
              <span *ngIf="sortField === 'phoneNumber'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('employmentType')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.EMPLOYMENT_TYPE' | translate }}</span>
              <span *ngIf="sortField === 'employmentType'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th (click)="sortUsers('skills')" class="sortable">
            <div class="header-content">
              <span>{{ 'USER.SKILLS' | translate }}</span>
              <span *ngIf="sortField === 'skills'" class="sort-icon">{{ sortDirection === 'asc' ? '▼' : '▲' }}</span>
            </div>
          </th>
          <th>{{ 'USER.ACTIONS' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers" [class.selected]="isUserSelected(user.id)" class="user-row">
          <td class="select-column" [attr.data-label]="'USER.SELECT_ALL_USERS' | translate">
            <div class="checkbox-container">
              <input 
                type="checkbox" 
                [id]="'user-checkbox-' + user.id"
                [checked]="isUserSelected(user.id)"
                (change)="toggleUserSelection(user.id, $event)"
                [attr.aria-label]="('USER.SELECT_ALL_USERS' | translate) + ': ' + user.firstName + ' ' + user.lastName"
                class="custom-checkbox"
              >
              <label [for]="'user-checkbox-' + user.id" class="sr-only">
                {{ user.firstName }} {{ user.lastName }} {{ 'USER.SELECT_ALL_USERS' | translate }}
              </label>
            </div>
          </td>
          <td [attr.data-label]="'USER.USERNAME' | translate">{{ user.username }}</td>
          <td [attr.data-label]="'USER.TITLE' | translate">{{ user.title || '-' }}</td>
          <td [attr.data-label]="'USER.FIRST_NAME' | translate">{{ user.firstName }}</td>
          <td [attr.data-label]="'USER.LAST_NAME' | translate">{{ user.lastName }}</td>
          <td [attr.data-label]="'USER.EMAIL' | translate">{{ user.email }}</td>
          <td [attr.data-label]="'USER.PHONE_NUMBER_SHORT' | translate">{{ user.phoneNumber || '-' }}</td>
          <td [attr.data-label]="'USER.EMPLOYMENT_TYPE' | translate">{{ user.employmentType === 'Internal' ? ('USER.INTERNAL' | translate) : ('USER.EXTERNAL' | translate) }}</td>
          <td [attr.data-label]="'USER.SKILLS' | translate">
            <div class="skills-list">
              <span class="skill-badge" *ngFor="let entry of user.skills">
                {{ entry?.skill?.name || ('USER.UNKNOWN_SKILL' | translate) }}
              </span>
            </div>
          </td>
          <td class="actions-column" [attr.data-label]="'USER.ACTIONS' | translate">
            <div class="action-buttons">
              <!-- Skills Management Button -->
              <button 
                class="btn btn-icon btn-edit" 
                (click)="editUser(user.id); $event.stopPropagation()" 
                *ngIf="isAdmin || isCompetenceLeader || user.id === currentUserId"
                [title]="'USER.MANAGE_SKILLS' | translate"
              >
                <i class="fa fa-cog"></i>
              </button>
              
              <!-- Details Button - for all available -->
              <button 
                class="btn btn-icon btn-details" 
                (click)="viewUserDetails(user.id); $event.stopPropagation()" 
                [title]="'USER.VIEW_DETAILS' | translate"
              >
                <i class="fa fa-user"></i>
              </button>
              <!-- Deactivate Button - for Admins and Competence Leaders -->
              <button 
                class="btn btn-icon btn-deactivate" 
                (click)="deactivateUser(user)" 
                *ngIf="(isAdmin || isCompetenceLeader) && user.id !== currentUserId"
                [title]="'USER.DEACTIVATE_USER_SHORT' | translate"
              >
                <i class="fa fa-user-slash"></i>
              </button>
              
              <!-- Delete Button - for Admins only -->
              <button 
                class="btn btn-icon btn-delete" 
                (click)="openDeleteDialog(user)" 
                *ngIf="isAdmin && user.id !== currentUserId"
                [title]="'USER.DELETE_USER' | translate"
              >
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="filteredUsers.length === 0">
          <td colspan="10" class="no-results">
            {{ 'USER.NO_USERS_FOUND' | translate }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
