<div class="user-details-page">
  <!-- Loading-Indikator -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <span>{{ 'PROFILE.LOADING' | translate }}</span>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="error-container">
    <div class="error-message">{{ error }}</div>
    <div class="error-actions">
      <button class="btn btn-primary" (click)="loadUserDetails()">{{ 'PROFILE.RETRY' | translate }}</button>
      <button class="btn btn-secondary" (click)="goBack()">{{ 'PROFILE.BACK_TO_LIST' | translate }}</button>
    </div>
  </div>

  <!-- User details -->
  <div *ngIf="user && !isLoading && !error" class="user-details-container">
    <!-- Header with profile image and main information -->
    <div class="user-header">
      <div class="user-avatar-container">
        <div *ngIf="!user.profileImageUrl" class="user-avatar">
          <span class="initials">{{ getUserInitials() }}</span>
        </div>
        <div *ngIf="user.profileImageUrl" class="user-avatar">
          <img
            [src]="getProfileImageUrl(user.profileImageUrl)"
            alt="Profilbild"
            class="profile-image"
            (error)="handleImageError()"
          >
          <div *ngIf="showInitialsOnError" class="initials-fallback">
            <span class="initials">{{ getUserInitials() }}</span>
          </div>
        </div>
      </div>

      <div class="user-info">
        <h1 class="user-name">{{ getUserFullName() }}</h1>
        <div class="user-username">{{'@'}}{{ user.username }}</div>

        <div class="user-role" *ngIf="user.role">
          <span class="label">{{ 'PROFILE.ROLE' | translate }}</span>
          <span class="value">{{ getFormattedRole() }}</span>
        </div>

        <div class="user-employment">
          <span class="label">{{ 'PROFILE.EMPLOYMENT_TYPE' | translate }}</span>
          <span class="value">{{ getEmploymentType() }}</span>
        </div>

        <div *ngIf="isAdmin || isOwnProfile()" class="admin-actions mt-3">
          <button class="btn btn-primary" (click)="editUser()">
            <i class="fa fa-pencil"></i> {{ 'PROFILE.EDIT_PROFILE' | translate }}
          </button>
          <button *ngIf="isAdmin" class="btn btn-secondary" (click)="sendEmail()">
            <i class="fa fa-envelope"></i> {{ 'PROFILE.SEND_EMAIL' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Detail information -->
    <div class="user-details-sections">
      <!-- Contact information -->
      <div class="details-section">
        <h2 class="section-title">{{ 'PROFILE.CONTACT_INFO' | translate }}</h2>
        <div class="info-row">
          <span class="info-label">{{ 'PROFILE.EMAIL' | translate }}</span>
          <span class="info-value">{{ user.email }}</span>
        </div>
        <div class="info-row" *ngIf="user.phoneNumber">
          <span class="info-label">{{ 'PROFILE.PHONE_NUMBER' | translate }}</span>
          <span class="info-value">{{ user.phoneNumber }}</span>
        </div>
      </div>

      <!-- Skills -->
      <div class="details-section">
        <h2 class="section-title">{{ 'PROFILE.SKILLS' | translate }}</h2>
        <div class="skills-container" *ngIf="user.skills && user.skills.length > 0">
          <div class="skill-card" *ngFor="let userSkill of user.skills">
            <div class="skill-header">
              <span class="skill-name">{{ userSkill.skill.name }}</span>
              <!-- The last level -->
              <span *ngIf="userSkill.levelHistory && userSkill.levelHistory.length > 0"
                    class="level-badge"
                    [ngClass]="getSkillLevelClass(userSkill.levelHistory[userSkill.levelHistory.length - 1].level)">
                {{ userSkill.levelHistory[userSkill.levelHistory.length - 1].level | translate }}
              </span>
            </div>
            <!-- Skill History -->
            <div class="skill-history">
              <div *ngFor="let history of userSkill.levelHistory; let i = index" class="skill-meta-modern">
                <span [class.current-level]="i === userSkill.levelHistory.length - 1">
                  Level '{{ history.level | translate }}'
                  <span *ngIf="history.changedBy">
                    {{ 'USER.BY' | translate }} {{ history.changedBy.firstName }} {{ history.changedBy.lastName }}
                  </span>
                  <span *ngIf="history.changedAt">
                    {{ 'USER.ON' | translate }} {{ history.changedAt | date:'short' }}
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="no-skills" *ngIf="!user.skills || user.skills.length === 0">
          {{ 'PROFILE.NO_SKILLS' | translate }}
        </div>
      </div>
    </div>

    <app-user-statistics [user]="user"></app-user-statistics>

    <!-- Comments -->
    <div class="comments-section">
      <h2 class="section-title">{{ 'PROFILE.COMMENTS' | translate }}</h2>

      <!-- Add comment (only for authorized users) -->
      <div class="add-comment-container" *ngIf="canAddComments">
        <textarea
          [(ngModel)]="newComment"
          [placeholder]="'PROFILE.COMMENT_PLACEHOLDER' | translate"
          class="comment-input"
          rows="3"
        ></textarea>
        <button
          class="btn btn-primary"
          [disabled]="!newComment.trim()"
          (click)="addComment()"
        >
          {{ 'PROFILE.ADD_COMMENT' | translate }}
        </button>
      </div>

      <!-- Comment filter -->
      <div class="comments-filter">
        <div class="filter-row">
          <input
            type="text"
            [(ngModel)]="commentSearchTerm"
            [placeholder]="'PROFILE.SEARCH_COMMENTS' | translate"
            class="search-input"
          >

          <div class="author-select-container">
            <!-- Dropdown with Toggle and Menu -->
            <div class="dropdown-wrapper">
              <!-- Dropdown toggle button -->
              <div class="author-dropdown-toggle" (click)="toggleAuthorDropdown()">
                <span>{{ selectedAuthor ? getAuthorNameById(selectedAuthor) : ('PROFILE.ALL_AUTHORS' | translate) }}</span>
                <span class="dropdown-arrow">{{ isAuthorDropdownOpen ? '▲' : '▼' }}</span>
              </div>

              <!-- Dropdown menu -->
              <div *ngIf="isAuthorDropdownOpen" class="author-dropdown-menu">
                <!-- Author list -->
                <div class="author-list">
                  <div
                    class="author-item"
                    [class.selected]="selectedAuthor === ''"
                    (click)="selectAuthor('')"
                  >
                    <span class="author-checkbox">
                      <span *ngIf="selectedAuthor === ''" class="check-mark">✓</span>
                    </span>
                    <span class="author-name">{{ 'PROFILE.ALL_AUTHORS' | translate }}</span>
                  </div>

                  <div
                    *ngFor="let author of getUniqueAuthors()"
                    class="author-item"
                    [class.selected]="selectedAuthor === author.id"
                    (click)="selectAuthor(author.id)"
                  >
                    <span class="author-checkbox">
                      <span *ngIf="selectedAuthor === author.id" class="check-mark">✓</span>
                    </span>
                    <span class="author-name">{{ author.name }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-row date-filters">
          <div class="date-filter">
            <label>{{ 'PROFILE.FROM' | translate }}</label>
            <div class="date-input-container">
              <input type="date" [(ngModel)]="dateFrom" class="date-input">
            </div>
          </div>

          <div class="date-filter">
            <label>{{ 'PROFILE.TO' | translate }}</label>
            <div class="date-input-container">
              <input type="date" [(ngModel)]="dateTo" class="date-input">
            </div>
          </div>
        </div>
      </div>

      <!-- Comment list -->
      <div class="comments-list">
        <div *ngIf="filterComments().length === 0" class="no-comments">
          {{ 'USER.NO_COMMENTS' | translate }}
        </div>

        <div *ngFor="let comment of filterComments()" class="comment-card">
          <div class="comment-header">
            <span class="comment-author">{{ comment.authorName }}</span>
            <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
          </div>
          <!-- Edit mode -->
          <div *ngIf="editingComment && editingComment.id === comment.id" class="edit-comment-form">
            <textarea
              [(ngModel)]="editCommentText"
              [placeholder]="'USER.COMMENT_PLACEHOLDER' | translate"
              class="edit-comment-input"
              rows="3"
            ></textarea>
            <div class="edit-comment-actions">
              <button
                class="btn btn-primary btn-sm"
                [disabled]="!editCommentText.trim()"
                (click)="saveEditComment()"
              >
                {{ 'COMMON.SAVE' | translate }}
              </button>
              <button
                class="btn btn-secondary btn-sm"
                (click)="cancelEditComment()"
              >
                {{ 'COMMON.CANCEL' | translate }}
              </button>
            </div>
          </div>

          <!-- Display mode -->
          <div *ngIf="!editingComment || editingComment.id !== comment.id" class="comment-text" [class.expanded]="isCommentExpanded(comment.id)">
            {{ getDisplayText(comment.text, isCommentExpanded(comment.id)) }}
            <button
              *ngIf="isTextTooLong(comment.text)"
              class="text-expand-btn"
              (click)="toggleCommentExpansion(comment.id)"
            >
              {{ isCommentExpanded(comment.id) ? ('PROFILE.SHOW_LESS' | translate) : ('PROFILE.SHOW_MORE' | translate) }}
            </button>
          </div>

          <!-- comment actions -->
          <div class="comment-actions">
            <button class="btn-reply" (click)="replyToComment(comment)">
              <i class="fa fa-reply"></i> {{ 'USER.REPLY' | translate }}
            </button>
            <!-- Edit button (only for author) -->
            <button
              *ngIf="isCommentAuthor(comment)"
              class="btn-edit"
              (click)="startEditComment(comment)"
              [disabled]="editingComment !== null"
            >
              <i class="fa fa-pencil"></i> {{ 'COMMON.EDIT' | translate }}
            </button>
            <!-- Delete button (for author or admin) -->
            <button
              *ngIf="canDeleteComment(comment)"
              class="btn-delete"
              (click)="deleteComment(comment)"
            >
              <i class="fa fa-trash"></i> {{ 'COMMON.DELETE' | translate }}
            </button>
          </div>

          <!-- reply form -->
          <div *ngIf="replyingToComment && replyingToComment.id === comment.id" class="reply-form">
            <textarea
              [(ngModel)]="replyText"
              [placeholder]="'USER.REPLY_PLACEHOLDER' | translate"
              class="reply-input"
              rows="2"
            ></textarea>
            <div class="reply-actions">
              <button
                class="btn btn-primary btn-sm"
                [disabled]="!replyText.trim()"
                (click)="addReply()"
              >
                {{ 'USER.REPLY' | translate }}
              </button>
              <button
                class="btn btn-secondary btn-sm"
                (click)="cancelReply()"
              >
                {{ 'USER.CANCEL' | translate }}
              </button>
            </div>
          </div>

          <!-- replies -->
          <div *ngIf="comment.replies && comment.replies.length > 0" class="replies-container">
            <div *ngFor="let reply of comment.replies" class="reply-card">
              <div class="reply-header">
                <span class="reply-author">{{ reply.authorName }}</span>
                <span class="reply-date">{{ formatDate(reply.createdAt) }}</span>
              </div>
              <div class="reply-text" [class.expanded]="isReplyExpanded(reply.id)">
                {{ getDisplayText(reply.text, isReplyExpanded(reply.id)) }}
                <button
                  *ngIf="isTextTooLong(reply.text)"
                  class="text-expand-btn"
                  (click)="toggleReplyExpansion(reply.id)"
                >
                  {{ isReplyExpanded(reply.id) ? ('USER.SHOW_LESS' | translate) : ('USER.SHOW_MORE' | translate) }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
